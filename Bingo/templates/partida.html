<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Online - Partida</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .status-container {
            margin: 20px 0;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        .cartelas-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .cartela {
            border: 2px solid #333;
            border-radius: 5px;
            padding: 10px;
            background-color: white;
        }
        .cartela-header {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 5px 0;
            border-radius: 3px;
        }
        .cartela-body {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 5px;
        }
        .numero {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            background-color: #f9f9f9;
            font-size: 18px;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .numero:hover {
            background-color: #e0e0e0;
            transform: scale(1.05);
        }

        .numero.marcado {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            transform: scale(1);
        }

        .numero.erro {
            background-color: #ff4444;
            color: white;
            animation: shake 0.5s;
        }

        .numero.faltando {
            border: 2px solid #ff4444;
            animation: pulse-border 1s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse-border {
            0% { border-color: #ff4444; }
            50% { border-color: #ff8888; }
            100% { border-color: #ff4444; }
        }

        .validation-message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
            font-weight: bold;
        }

        .validation-errors {
            margin-top: 10px;
            font-size: 14px;
            color: #d32f2f;
        }
        .numeros-sorteados {
            margin-top: 20px;
            text-align: center;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            max-width: 800px;
        }
        .numero-sorteado {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-weight: bold;
        }
        .contagem {
            font-size: 48px;
            font-weight: bold;
            color: #2196F3;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: #e3f2fd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            animation: pulse 1s infinite;
        }

        .contagem.urgente {
            color: #f44336;
            background: #ffebee;
            animation: pulse 0.5s infinite;
        }

        .contagem.final {
            color: #4CAF50;
            background: #e8f5e9;
            animation: none;
        }
        .ultimo-sorteado {
            font-size: 48px;
            font-weight: bold;
            color: #2196F3;
            margin: 20px 0;
            padding: 30px;
            border-radius: 20px;
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            box-shadow: 0 8px 16px rgba(33, 150, 243, 0.15);
            animation: aparecer 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            min-width: 200px;
            display: inline-block;
        }
        @keyframes aparecer {
            from {
                opacity: 0;
                transform: scale(0.6) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
            }
            
            50% {
                transform: scale(1.02);
                box-shadow: 0 8px 20px rgba(255, 68, 68, 0.5);
            }
            
            100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
            }
        }
        .jogadores {
            margin: 20px 0;
            font-size: 18px;
        }
        .aguardando {
            color: #666;
            font-style: italic;
        }
        .bingo-button {
            padding: 20px 40px;
            font-size: 32px;
            font-weight: bold;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin: 20px 0;
            animation: pulse 2s infinite;
            display: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .bingo-button:hover {
            background-color: #ff0000;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(255, 68, 68, 0.4);
        }
        
        .bingo-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.2);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Partida: {{ codigo }}</h1>
        <div class="jogadores" id="jogadores">Aguardando jogadores...</div>
        <div class="status-container">
            <div id="status">Aguardando outro jogador...</div>
            <div id="contagem" class="contagem" style="display: none;"></div>
            <div id="ultimo-sorteado" class="ultimo-sorteado" style="display: none;"></div>
            <div id="validation-message" class="validation-message"></div>
            <button id="bingo-btn" class="bingo-button" style="display: none;" onclick="verificarBingo()">BINGO!</button>
        </div>
        
        <div class="cartelas-container" id="cartelas-container"></div>
        
        <div class="numeros-sorteados" id="numeros-sorteados">
            <h3>Números Sorteados</h3>
            <div id="lista-numeros"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const codigoPartida = '{{ codigo }}';
        const nomeJogador = '{{ nome_jogador }}';
        let jogadoresConectados = [];
        let estadoJogo = 'aguardando';
        let numerosSorteados = new Set();
        let cartelasJogador = [];
        
        // Solicita as cartelas ao conectar
        socket.on('connect', () => {
            console.log('Conectado ao servidor');
            socket.emit('solicitar_cartelas');
        });
        
        socket.on('jogador_entrou', (data) => {
            console.log('Jogador entrou:', data.nome);
            if (!jogadoresConectados.includes(data.nome)) {
                jogadoresConectados.push(data.nome);
            }
            atualizarListaJogadores();
            atualizarStatusJogo();
        });
        
        function atualizarListaJogadores() {
            const jogadoresDiv = document.getElementById('jogadores');
            if (jogadoresConectados.length === 0) {
                jogadoresDiv.textContent = 'Aguardando jogadores...';
                jogadoresDiv.className = 'jogadores aguardando';
            } else {
                jogadoresDiv.textContent = 'Jogadores: ' + jogadoresConectados.join(', ');
                jogadoresDiv.className = 'jogadores';
            }
        }

        function atualizarStatusJogo() {
            const statusDiv = document.getElementById('status');
            const contagemDiv = document.getElementById('contagem');
            const ultimoSorteadoDiv = document.getElementById('ultimo-sorteado');

            switch (estadoJogo) {
                case 'aguardando':
                    statusDiv.textContent = jogadoresConectados.length < 2 ? 
                        'Aguardando outro jogador...' : 
                        'Preparando para iniciar...';
                    contagemDiv.style.display = 'none';
                    ultimoSorteadoDiv.style.display = 'none';
                    break;
                case 'contagem':
                    statusDiv.textContent = 'Iniciando jogo em...';
                    contagemDiv.style.display = 'block';
                    ultimoSorteadoDiv.style.display = 'none';
                    break;
                case 'em_andamento':
                    statusDiv.textContent = 'Jogo em andamento!';
                    contagemDiv.style.display = 'none';
                    ultimoSorteadoDiv.style.display = 'block';
                    break;
                case 'finalizado':
                    statusDiv.textContent = 'Fim do jogo!';
                    contagemDiv.style.display = 'none';
                    break;
            }
        }
        
        socket.on('iniciar_contagem', () => {
            console.log('Iniciando contagem regressiva');
            estadoJogo = 'contagem';
            atualizarStatusJogo();
        });
        
        socket.on('atualizar_contagem', (data) => {
            console.log('Atualizando contagem:', data.segundos);
            const contagemDiv = document.getElementById('contagem');
            contagemDiv.textContent = data.segundos;
        });
        
        socket.on('jogo_iniciado', () => {
            console.log('Jogo iniciado');
            estadoJogo = 'em_andamento';
            atualizarStatusJogo();
            document.getElementById('bingo-btn').style.display = 'block';
        });
        
        socket.on('cartelas', (data) => {
            const container = document.getElementById('cartelas-container');
            container.innerHTML = '';
            cartelasJogador = data.cartelas;
            
            data.cartelas.forEach((cartela, cartelaIndex) => {
                const cartelaDiv = document.createElement('div');
                cartelaDiv.className = 'cartela';
                cartelaDiv.dataset.cartelaIndex = cartelaIndex;
                
                const header = document.createElement('div');
                header.className = 'cartela-header';
                header.innerHTML = '<div>B</div><div>I</div><div>N</div><div>G</div><div>O</div>';
                
                const body = document.createElement('div');
                body.className = 'cartela-body';
                
                for (let i = 0; i < 5; i++) {
                    for (let j = 0; j < 5; j++) {
                        const numero = cartela.numeros[i][j];
                        const marcado = cartela.marcacao[i][j];
                        
                        const numeroDiv = document.createElement('div');
                        numeroDiv.className = `numero ${marcado ? 'marcado' : ''}`;
                        numeroDiv.textContent = numero || '';
                        numeroDiv.dataset.row = i;
                        numeroDiv.dataset.col = j;
                        numeroDiv.onclick = () => toggleMarcacao(numeroDiv, cartelaIndex, i, j, numero);
                        body.appendChild(numeroDiv);
                    }
                }
                
                cartelaDiv.appendChild(header);
                cartelaDiv.appendChild(body);
                container.appendChild(cartelaDiv);
            });
        });
        
        function toggleMarcacao(elemento, cartelaIndex, row, col, numero) {
            if (estadoJogo !== 'em_andamento') return;
            
            const estaMarcado = elemento.classList.toggle('marcado');
            cartelasJogador[cartelaIndex].marcacao[row][col] = estaMarcado;
        }

        function verificarBingo() {
            const validationMessage = document.getElementById('validation-message');
            let erros = {
                numerosNaoSorteados: [],
                numerosSorteadosNaoMarcados: []
            };
            let bingoValido = true;

            // Remove marcações de erro anteriores
            document.querySelectorAll('.numero.erro, .numero.faltando').forEach(el => {
                el.classList.remove('erro', 'faltando');
            });

            // Verifica cada cartela do jogador
            for (let cartelaIndex = 0; cartelaIndex < cartelasJogador.length; cartelaIndex++) {
                const cartela = cartelasJogador[cartelaIndex];
                const cartelaElement = document.querySelector(`[data-cartela-index="${cartelaIndex}"]`);

                // Verifica números marcados incorretamente
                for (let i = 0; i < 5; i++) {
                    for (let j = 0; j < 5; j++) {
                        const numero = cartela.numeros[i][j];
                        const estaMarcado = cartela.marcacao[i][j];
                        const numeroElement = cartelaElement.querySelector(`[data-row="${i}"][data-col="${j}"]`);

                        if (estaMarcado && !numerosSorteados.has(numero)) {
                            erros.numerosNaoSorteados.push(numero);
                            numeroElement.classList.add('erro');
                            bingoValido = false;
                        }
                        
                        if (!estaMarcado && numerosSorteados.has(numero)) {
                            erros.numerosSorteadosNaoMarcados.push(numero);
                            numeroElement.classList.add('faltando');
                            bingoValido = false;
                        }
                    }
                }
            }

            validationMessage.style.display = 'block';
            
            if (bingoValido) {
                console.log('Bingo válido! Gritando BINGO!');
                validationMessage.className = 'validation-message success';
                validationMessage.innerHTML = 'Verificando seu BINGO...';
                gritarBingo();
            } else {
                let mensagemErro = 'Bingo inválido!';
                if (erros.numerosNaoSorteados.length > 0) {
                    mensagemErro += `<div class="validation-errors">Números marcados que ainda não foram sorteados: ${erros.numerosNaoSorteados.join(', ')}</div>`;
                }
                if (erros.numerosSorteadosNaoMarcados.length > 0) {
                    mensagemErro += `<div class="validation-errors">Números sorteados que não foram marcados: ${erros.numerosSorteadosNaoMarcados.join(', ')}</div>`;
                }
                
                validationMessage.className = 'validation-message error';
                validationMessage.innerHTML = mensagemErro;
                
                setTimeout(() => {
                    validationMessage.style.display = 'none';
                    // Remove as marcações de erro após 5 segundos
                    document.querySelectorAll('.numero.erro, .numero.faltando').forEach(el => {
                        el.classList.remove('erro', 'faltando');
                    });
                }, 5000);
            }
        }
        
        socket.on('numero_sorteado', (data) => {
            console.log('Número sorteado:', data.numero);
            numerosSorteados.add(data.numero);
            const ultimoSorteado = document.getElementById('ultimo-sorteado');
            ultimoSorteado.style.display = 'block';
            ultimoSorteado.innerHTML = `<span style="font-size: 24px; display: block; margin-bottom: 10px; color: #1976D2;">Número sorteado</span>${data.numero}`;
            
            // Reinicia a animação
            ultimoSorteado.style.animation = 'none';
            ultimoSorteado.offsetHeight;
            ultimoSorteado.style.animation = 'aparecer 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            
            // Adiciona o número à lista de números sorteados
            const listaNumeros = document.getElementById('lista-numeros');
            const numeroSpan = document.createElement('span');
            numeroSpan.className = 'numero-sorteado';
            numeroSpan.textContent = data.numero;
            listaNumeros.appendChild(numeroSpan);
        });
        
        function gritarBingo() {
            console.log('Gritando BINGO!');
            socket.emit('bingo', { codigo: codigoPartida });
            document.getElementById('bingo-btn').style.display = 'none';
        }
        
        socket.on('bingo', (data) => {
            estadoJogo = 'finalizado';
            atualizarStatusJogo();
            document.getElementById('bingo-btn').style.display = 'none';
            if (data.vencedor === nomeJogador) {
                alert('PARABÉNS! Você fez BINGO!');
            } else {
                alert(`${data.vencedor} fez BINGO!`);
            }
        });

        // Reconexão
        socket.on('disconnect', () => {
            console.log('Desconectado do servidor');
        });

        socket.on('connect_error', (error) => {
            console.log('Erro de conexão:', error);
        });

        socket.on('atualizar_estado', (data) => {
            console.log('Estado atualizado:', data);
            estadoJogo = data.estado;
            const status = document.getElementById('status');
            const contagem = document.getElementById('contagem');
            const bingoBtn = document.getElementById('bingo-btn');
            
            switch (data.estado) {
                case 'aguardando':
                    status.textContent = 'Aguardando outro jogador...';
                    contagem.style.display = 'none';
                    bingoBtn.style.display = 'none';
                    break;
                    
                case 'contagem':
                    status.textContent = 'O jogo começará em...';
                    contagem.style.display = 'block';
                    contagem.textContent = data.contagem;
                    bingoBtn.style.display = 'none';
                    
                    // Adiciona classes de estilo baseadas no tempo restante
                    if (data.contagem <= 5) {
                        contagem.classList.add('urgente');
                    } else if (data.contagem <= 10) {
                        contagem.classList.add('final');
                    }
                    break;
                    
                case 'em_andamento':
                    status.textContent = 'Jogo em andamento!';
                    contagem.style.display = 'none';
                    bingoBtn.style.display = 'block';
                    break;
                    
                case 'finalizado':
                    status.textContent = 'Jogo finalizado!';
                    contagem.style.display = 'none';
                    bingoBtn.style.display = 'none';
                    break;
            }
        });

        socket.on('atualizar_jogadores', (data) => {
            console.log('Jogadores atualizados:', data);
            const jogadoresDiv = document.getElementById('jogadores');
            jogadoresDiv.innerHTML = data.jogadores.map(jogador => 
                `<div class="jogador">${jogador}</div>`
            ).join('');
        });

        socket.on('erro', (data) => {
            console.error('Erro:', data);
            alert(data.mensagem);
        });

        // Função para entrar na sala
        function entrarSala() {
            const codigo = document.getElementById('codigo').value;
            const nome = document.getElementById('nome').value;
            
            if (!codigo || !nome) {
                alert('Por favor, preencha o código e o nome');
                return;
            }
            
            socket.emit('entrar_sala', {
                codigo: codigo,
                nome: nome
            });
        }

        // Função para sair da sala
        function sairSala() {
            const codigo = document.getElementById('codigo').value;
            socket.emit('sair_sala', { codigo: codigo });
            window.location.href = '/';
        }

        // Função para iniciar o jogo
        function iniciarJogo() {
            const codigo = document.getElementById('codigo').value;
            socket.emit('iniciar_jogo', { codigo: codigo });
        }
    </script>
</body>
</html> 